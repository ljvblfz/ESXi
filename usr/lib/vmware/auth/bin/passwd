#!/bin/python

#
# Copyright 2011-2012 VMware, Inc.  All rights reserved.
#
# passwd wrapper that uses the environment variable $USER rather than
# the raw uid
#

import sys
import os
import subprocess

from optparse import OptionParser


BUSYBOX_CMD = '/usr/lib/vmware/busybox/bin/busybox'

def main():

    usage = "passwd [options] [user]"

    parser = OptionParser(usage)

    parser.add_option("-s", "--stdin", dest="stdin", action="store_true",
                      default=False, help="Take password from stdin")

    (options, args) = parser.parse_args()

    if len(args) > 1:
        parser.error("Too many arguments")

    if len(args) == 0:
        if not 'USER' in os.environ:
            parser.error("$USER environment not set and no user specified")
        else:
            user = os.environ['USER']
    else:
        user = args[0]


    call_args = [BUSYBOX_CMD, 'passwd']
    if options.stdin:
        call_args.append("--stdin")

    call_args.append(user)

    return subprocess.call(call_args);


if __name__ == '__main__':
    try:
        sys.exit(main())
    except Exception as e:
        raise
